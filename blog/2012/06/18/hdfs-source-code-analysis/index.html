
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>HDFS Source Code Analysis - My Personal Blog</title>
  <meta name="author" content="jjyao">

  
  <meta name="description" content="创建FileSystem
HDFS客户端向服务器发送rpc请求
HDFS服务器对客户端rpc请求的处理
DataNode中和数据相关的类
DataNode的启动
参考资料 创建FileSystem FileSystem在Hadoop中只是一个抽象类，它屏蔽了各种底层文件系统的实现， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://JiajunYao.github.com/blog/2012/06/18/hdfs-source-code-analysis">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="My Personal Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32781930-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My Personal Blog</a></h1>
  
    <h2>Stay hungry, Stay foolish.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:JiajunYao.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/categories/debug">Debug</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About Me</a></li>
  <li><a href="/quotes/quotes.html">Quotes</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">HDFS Source Code Analysis</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-18T19:28:00+08:00" pubdate data-updated="true">Jun 18<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><ol>
<li><a href="#instantiate_FileSystem">创建FileSystem</a></li>
<li><a href="#hdfs_client_send_request">HDFS客户端向服务器发送rpc请求</a></li>
<li><a href="#hdfs_server_handle_client_request">HDFS服务器对客户端rpc请求的处理</a></li>
<li><a href="#hdfs_datanode_storage_related_class">DataNode中和数据相关的类</a></li>
<li><a href="#hdfs_datanode_start">DataNode的启动</a></li>
<li><a href="#reference">参考资料</a></li>
</ol>


<!-- more -->


<h2><a id="instantiate_FileSystem"></a>创建FileSystem</h2>

<p>FileSystem在Hadoop中只是一个抽象类，它屏蔽了各种底层文件系统的实现，这有点Linux VFS的味道。在Hadoop中各个文件系统的实现都是继承了FileSystem这个抽象类的，因此用户只需要通过FileSystem的接口来操作底层的文件系统就可以了。Hadoop中具体的文件系统实现有很多，如DistributedFileSystem和LocalFileSystem。如何告知Hadoop要使用哪一个具体的文件系统实现是这节要讨论的。</p>

<p>在这里我们可以通过在Hadoop的配置文件里指定fs.default.name来实现，当然也可以在程序中显式指定。假设我们指定fs.default.name的值为hdfs://localhost:9000，其中的<em>hdfs</em>就是告诉Hadoop要使用DistributedFileSystem。Hadoop会从fs.default.name中抽出hdfs，然后去配置文件里找fs.<em>hdfs</em>.impl，这个可以在core-default.xml中找到，值为org.apache.hadoop.hdfs.DistributedFileSystem，可以看出Hadoop已经成功找到具体要创建的文件系统实现是什么了，接下来Hadoop通过反射就能由类名创建出类实例来，然后返回给用户使用。类似的如果我们指定fs.default.name的值为file:///，那么Hadoop就会去配置文件里找fs.<em>file</em>.impl，这个的值就是org.apache.hadoop.fs.LocalFileSystem。当然我们还能给fs.default.name指定很多其他的值来告诉Hadoop要使用的底层文件系统实现是什么。在这里还要说明的是fs.default.name的默认值就是file:///。接下来给出一些关键代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/** FileSystem.java **/</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* 创建FileSystem的工厂方法 */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">FileSystem</span> <span class="nf">get</span><span class="o">(</span><span class="n">Configuration</span> <span class="n">conf</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">get</span><span class="o">(</span><span class="n">getDefaultUri</span><span class="o">(</span><span class="n">conf</span><span class="o">),</span> <span class="n">conf</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* 获取配置文件中fs.default.name的值，并转化成一个URI对象 */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">URI</span> <span class="nf">getDefaultUri</span><span class="o">(</span><span class="n">Configuration</span> <span class="n">conf</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">URI</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">fixName</span><span class="o">(</span><span class="n">conf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">FS_DEFAULT_NAME_KEY</span><span class="o">,</span> <span class="s">&quot;file:///&quot;</span><span class="o">)));</span> <span class="c1">// FS_DEFAULT_NAME_KEY的值就是fs.default.name</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">FileSystem</span> <span class="nf">get</span><span class="o">(</span><span class="n">URI</span> <span class="n">uri</span><span class="o">,</span> <span class="n">Configuration</span> <span class="n">conf</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
</span><span class='line'>    <span class="n">Key</span> <span class="n">key</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Key</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">conf</span><span class="o">);</span>
</span><span class='line'>    <span class="n">FileSystem</span> <span class="n">fs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">fs</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">fs</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">fs</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fs</span> <span class="o">=</span> <span class="n">createFileSystem</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">conf</span><span class="o">);</span> <span class="c1">// 只关注这个函数</span>
</span><span class='line'>    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">// refetch the lock again</span>
</span><span class='line'>        <span class="n">FileSystem</span> <span class="n">oldfs</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">oldfs</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// a file system is created while lock is releasing</span>
</span><span class='line'>            <span class="n">fs</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="c1">// close the new file system</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">oldfs</span><span class="o">;</span>  <span class="c1">// return the old file system</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// now insert the new file system into the map</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">clientFinalizer</span><span class="o">.</span><span class="na">isAlive</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">addShutdownHook</span><span class="o">(</span><span class="n">clientFinalizer</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">fs</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
</span><span class='line'>        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">fs</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">fs</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="n">FileSystem</span> <span class="nf">createFileSystem</span><span class="o">(</span><span class="n">URI</span> <span class="n">uri</span><span class="o">,</span> <span class="n">Configuration</span> <span class="n">conf</span>
</span><span class='line'>        <span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// 从fs.default.name的值中抽取出scheme部分，也就是开头的那部分。然后从配置文件中找fs.**.impl的值，也就是要实例的类的名字</span>
</span><span class='line'>    <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">&quot;fs.&quot;</span> <span class="o">+</span> <span class="n">uri</span><span class="o">.</span><span class="na">getScheme</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;.impl&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>    <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Creating filesystem for &quot;</span> <span class="o">+</span> <span class="n">uri</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">&quot;No FileSystem for scheme: &quot;</span> <span class="o">+</span> <span class="n">uri</span><span class="o">.</span><span class="na">getScheme</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="c1">// 反射，根据类名创建类实例</span>
</span><span class='line'>    <span class="n">FileSystem</span> <span class="n">fs</span> <span class="o">=</span> <span class="o">(</span><span class="n">FileSystem</span><span class="o">)</span><span class="n">ReflectionUtils</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">conf</span><span class="o">);</span>
</span><span class='line'>    <span class="n">fs</span><span class="o">.</span><span class="na">initialize</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">conf</span><span class="o">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">fs</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2><a id="hdfs_client_send_request"></a>HDFS客户端向服务器发送rpc请求</h2>

<p>对于HDFS来说我们是通过DistributedFileSystem来进行文件系统的操作的，在这里DistributedFileSystem就是client，而server就跑在NameNode上面。我们通过DistributedFileSystem发出的所有操作都会通过rpc传递到NameNode的server上，然后再执行最后将结果返回。这就是client和server之间的rpc。</p>

<p>这节谈论client如何将用户对DistributedFileSystem的方法调用传递到server端。在这里我们以<code>mkdirs()</code>方法为例，假设用户调用了DistributedFileSystem的<code>mkdirs()</code>方法，代码如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">mkdirs</span><span class="o">(</span><span class="n">Path</span> <span class="n">f</span><span class="o">,</span> <span class="n">FsPermission</span> <span class="n">permission</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">statistics</span><span class="o">.</span><span class="na">incrementWriteOps</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">dfs</span><span class="o">.</span><span class="na">mkdirs</span><span class="o">(</span><span class="n">getPathName</span><span class="o">(</span><span class="n">f</span><span class="o">),</span> <span class="n">permission</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到DistributedFileSystem将方法调用转交给了实例变量dfs，这个就是DFSClient的实例，这个是rpc的一个关键点，官方文档对这个类的描述是</p>

<blockquote><p>DFSClient can connect to a Hadoop Filesystem and perform basic file tasks. It uses the ClientProtocol to communicate with a NameNode daemon, and connects directly to DataNodes to read/write block data. Hadoop DFS users should obtain an instance of DistributedFileSystem, which uses DFSClient to handle filesystem tasks.</p></blockquote>

<p>可以看出DistributedFileSystem将所有对文件系统的操作都转交给了DFSClient来处理。接下来我们就看看DFSClient是怎么处理的。代码如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/* DistributedFileSystem.java */</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">URI</span> <span class="n">uri</span><span class="o">,</span> <span class="n">Configuration</span> <span class="n">conf</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">super</span><span class="o">.</span><span class="na">initialize</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">conf</span><span class="o">);</span>
</span><span class='line'>    <span class="n">setConf</span><span class="o">(</span><span class="n">conf</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">String</span> <span class="n">host</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="na">getHost</span><span class="o">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">host</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">&quot;Incomplete HDFS URI, no host: &quot;</span><span class="o">+</span> <span class="n">uri</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">InetSocketAddress</span> <span class="n">namenode</span> <span class="o">=</span> <span class="n">NameNode</span><span class="o">.</span><span class="na">getAddress</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">getAuthority</span><span class="o">());</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">dfs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DFSClient</span><span class="o">(</span><span class="n">namenode</span><span class="o">,</span> <span class="n">conf</span><span class="o">,</span> <span class="n">statistics</span><span class="o">);</span> <span class="c1">// 创建了DFSClient的实例</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">uri</span> <span class="o">=</span> <span class="n">URI</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">getScheme</span><span class="o">()+</span><span class="s">&quot;://&quot;</span><span class="o">+</span><span class="n">uri</span><span class="o">.</span><span class="na">getAuthority</span><span class="o">());</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">workingDir</span> <span class="o">=</span> <span class="n">getHomeDirectory</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* DFSClient.java */</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">mkdirs</span><span class="o">(</span><span class="n">String</span> <span class="n">src</span><span class="o">,</span> <span class="n">FsPermission</span> <span class="n">permission</span><span class="o">)</span><span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
</span><span class='line'>    <span class="c1">// omitted</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">namenode</span><span class="o">.</span><span class="na">mkdirs</span><span class="o">(</span><span class="n">src</span><span class="o">,</span> <span class="n">masked</span><span class="o">);</span>
</span><span class='line'>    <span class="c1">// omitted</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** </span>
</span><span class='line'><span class="cm">* Create a new DFSClient connected to the given nameNodeAddr or rpcNamenode.</span>
</span><span class='line'><span class="cm">* Exactly one of nameNodeAddr or rpcNamenode must be null.</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="n">DFSClient</span><span class="o">(</span><span class="n">InetSocketAddress</span> <span class="n">nameNodeAddr</span><span class="o">,</span> <span class="n">ClientProtocol</span> <span class="n">rpcNamenode</span><span class="o">,</span>
</span><span class='line'>  <span class="n">Configuration</span> <span class="n">conf</span><span class="o">,</span> <span class="n">FileSystem</span><span class="o">.</span><span class="na">Statistics</span> <span class="n">stats</span><span class="o">)</span>
</span><span class='line'><span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// omitted</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">rpcNamenode</span> <span class="o">=</span> <span class="n">createRPCNamenode</span><span class="o">(</span><span class="n">nameNodeAddr</span><span class="o">,</span> <span class="n">conf</span><span class="o">,</span> <span class="n">ugi</span><span class="o">);</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">namenode</span> <span class="o">=</span> <span class="n">createNamenode</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">rpcNamenode</span><span class="o">);</span>
</span><span class='line'>    <span class="c1">// omitted</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="n">ClientProtocol</span> <span class="nf">createRPCNamenode</span><span class="o">(</span><span class="n">InetSocketAddress</span> <span class="n">nameNodeAddr</span><span class="o">,</span>
</span><span class='line'>  <span class="n">Configuration</span> <span class="n">conf</span><span class="o">,</span> <span class="n">UserGroupInformation</span> <span class="n">ugi</span><span class="o">)</span>
</span><span class='line'>    <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">(</span><span class="n">ClientProtocol</span><span class="o">)</span><span class="n">RPC</span><span class="o">.</span><span class="na">getProxy</span><span class="o">(</span><span class="n">ClientProtocol</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
</span><span class='line'>        <span class="n">ClientProtocol</span><span class="o">.</span><span class="na">versionID</span><span class="o">,</span> <span class="n">nameNodeAddr</span><span class="o">,</span> <span class="n">ugi</span><span class="o">,</span> <span class="n">conf</span><span class="o">,</span>
</span><span class='line'>        <span class="n">NetUtils</span><span class="o">.</span><span class="na">getSocketFactory</span><span class="o">(</span><span class="n">conf</span><span class="o">,</span> <span class="n">ClientProtocol</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* RPC.java */</span>
</span><span class='line'><span class="cm">/** Construct a client-side proxy object that implements the named protocol,</span>
</span><span class='line'><span class="cm"> * talking to a server at the named address. */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">VersionedProtocol</span> <span class="nf">getProxy</span><span class="o">(</span>
</span><span class='line'>        <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">VersionedProtocol</span><span class="o">&gt;</span> <span class="n">protocol</span><span class="o">,</span>
</span><span class='line'>        <span class="kt">long</span> <span class="n">clientVersion</span><span class="o">,</span> <span class="n">InetSocketAddress</span> <span class="n">addr</span><span class="o">,</span> <span class="n">UserGroupInformation</span> <span class="n">ticket</span><span class="o">,</span>
</span><span class='line'>        <span class="n">Configuration</span> <span class="n">conf</span><span class="o">,</span> <span class="n">SocketFactory</span> <span class="n">factory</span><span class="o">,</span> <span class="kt">int</span> <span class="n">rpcTimeout</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">UserGroupInformation</span><span class="o">.</span><span class="na">isSecurityEnabled</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">SaslRpcServer</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">conf</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">VersionedProtocol</span> <span class="n">proxy</span> <span class="o">=</span>
</span><span class='line'>        <span class="o">(</span><span class="n">VersionedProtocol</span><span class="o">)</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span>
</span><span class='line'>                <span class="n">protocol</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="n">protocol</span> <span class="o">},</span>
</span><span class='line'>                <span class="k">new</span> <span class="nf">Invoker</span><span class="o">(</span><span class="n">protocol</span><span class="o">,</span> <span class="n">addr</span><span class="o">,</span> <span class="n">ticket</span><span class="o">,</span> <span class="n">conf</span><span class="o">,</span> <span class="n">factory</span><span class="o">,</span> <span class="n">rpcTimeout</span><span class="o">));</span>
</span><span class='line'>    <span class="kt">long</span> <span class="n">serverVersion</span> <span class="o">=</span> <span class="n">proxy</span><span class="o">.</span><span class="na">getProtocolVersion</span><span class="o">(</span><span class="n">protocol</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
</span><span class='line'>            <span class="n">clientVersion</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">serverVersion</span> <span class="o">==</span> <span class="n">clientVersion</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">proxy</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">VersionMismatch</span><span class="o">(</span><span class="n">protocol</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">clientVersion</span><span class="o">,</span>
</span><span class='line'>                <span class="n">serverVersion</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="n">ClientProtocol</span> <span class="nf">createNamenode</span><span class="o">(</span><span class="n">ClientProtocol</span> <span class="n">rpcNamenode</span><span class="o">)</span>
</span><span class='line'>    <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">RetryPolicy</span> <span class="n">createPolicy</span> <span class="o">=</span> <span class="n">RetryPolicies</span><span class="o">.</span><span class="na">retryUpToMaximumCountWithFixedSleep</span><span class="o">(</span>
</span><span class='line'>            <span class="mi">5</span><span class="o">,</span> <span class="n">LEASE_SOFTLIMIT_PERIOD</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Exception</span><span class="o">&gt;,</span><span class="n">RetryPolicy</span><span class="o">&gt;</span> <span class="n">remoteExceptionToPolicyMap</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Exception</span><span class="o">&gt;,</span> <span class="n">RetryPolicy</span><span class="o">&gt;();</span>
</span><span class='line'>    <span class="n">remoteExceptionToPolicyMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">AlreadyBeingCreatedException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">createPolicy</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Exception</span><span class="o">&gt;,</span><span class="n">RetryPolicy</span><span class="o">&gt;</span> <span class="n">exceptionToPolicyMap</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Exception</span><span class="o">&gt;,</span> <span class="n">RetryPolicy</span><span class="o">&gt;();</span>
</span><span class='line'>    <span class="n">exceptionToPolicyMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">RemoteException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
</span><span class='line'>            <span class="n">RetryPolicies</span><span class="o">.</span><span class="na">retryByRemoteException</span><span class="o">(</span>
</span><span class='line'>                <span class="n">RetryPolicies</span><span class="o">.</span><span class="na">TRY_ONCE_THEN_FAIL</span><span class="o">,</span> <span class="n">remoteExceptionToPolicyMap</span><span class="o">));</span> <span class="c1">// 控制retry的策略 TRY_ONCE_THEN_FAIL</span>
</span><span class='line'>    <span class="n">RetryPolicy</span> <span class="n">methodPolicy</span> <span class="o">=</span> <span class="n">RetryPolicies</span><span class="o">.</span><span class="na">retryByException</span><span class="o">(</span>
</span><span class='line'>            <span class="n">RetryPolicies</span><span class="o">.</span><span class="na">TRY_ONCE_THEN_FAIL</span><span class="o">,</span> <span class="n">exceptionToPolicyMap</span><span class="o">);</span>
</span><span class='line'>    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">RetryPolicy</span><span class="o">&gt;</span> <span class="n">methodNameToPolicyMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">RetryPolicy</span><span class="o">&gt;();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">methodNameToPolicyMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">methodPolicy</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="o">(</span><span class="n">ClientProtocol</span><span class="o">)</span> <span class="n">RetryProxy</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">ClientProtocol</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
</span><span class='line'>            <span class="n">rpcNamenode</span><span class="o">,</span> <span class="n">methodNameToPolicyMap</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到DFSClient又将方法调用转交给了实例变量namenode，于是我们就要了解namenode和与其有关的rpcNamenode这两个实例变量。对于DFSClient的构造函数，这里只显示最重要的两样东西分别是namenode和rpcNamenode。要了解这两样东西首先需要了解Java的<a href="http://docs.oracle.com/javase/1.4.2/docs/guide/reflection/proxy.html">Dynamic Proxy</a>。我们可以看到rpcNamenode实现了ClientProtocol接口，这个接口就规定了client能向server调用的所有方法。按照Dynamic Proxy的机制我们知道所有对rpcNamenode的方法调用全部归结到了Invoker的<code>invoke()</code>方法上了，这个方法就是将client的调用信息如调用的方法，参数等通过socket传递给server，并获得返回结果。对于Invoker的<code>invoke()</code>方法的剖析这里就不在描述了，可以通过参考链接了解更多。至此client的方法调用就顺利传递到server了。照这样看DFSClient就只要调用rpcNamenode的<code>mkdirs()</code>方法就好了，为什么还要namenode呢？要了解这个就需要RetryProxy的代码了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/* RetryProxy.java */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">create</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">iface</span><span class="o">,</span> <span class="n">Object</span> <span class="n">implementation</span><span class="o">,</span>
</span><span class='line'>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">RetryPolicy</span><span class="o">&gt;</span> <span class="n">methodNameToPolicyMap</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span>
</span><span class='line'>            <span class="n">implementation</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">(),</span>
</span><span class='line'>            <span class="k">new</span> <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="o">{</span> <span class="n">iface</span> <span class="o">},</span>
</span><span class='line'>            <span class="k">new</span> <span class="nf">RetryInvocationHandler</span><span class="o">(</span><span class="n">implementation</span><span class="o">,</span> <span class="n">methodNameToPolicyMap</span><span class="o">)</span>
</span><span class='line'>            <span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* RetryInvocationHandler.java */</span>
</span><span class='line'><span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
</span><span class='line'>    <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">RetryPolicy</span> <span class="n">policy</span> <span class="o">=</span> <span class="n">methodNameToPolicyMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">policy</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">policy</span> <span class="o">=</span> <span class="n">defaultPolicy</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="nf">invokeMethod</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(!</span><span class="n">policy</span><span class="o">.</span><span class="na">shouldRetry</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">retries</span><span class="o">++))</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Exception while invoking &quot;</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
</span><span class='line'>                        <span class="o">+</span> <span class="s">&quot; of &quot;</span> <span class="o">+</span> <span class="n">implementation</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;. Not retrying.&quot;</span>
</span><span class='line'>                        <span class="o">+</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">stringifyException</span><span class="o">(</span><span class="n">e</span><span class="o">));</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(!</span><span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">Void</span><span class="o">.</span><span class="na">TYPE</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>                    <span class="k">throw</span> <span class="n">e</span><span class="o">;</span> <span class="c1">// non-void methods can&#39;t fail without an exception</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Exception while invoking &quot;</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
</span><span class='line'>                    <span class="o">+</span> <span class="s">&quot; of &quot;</span> <span class="o">+</span> <span class="n">implementation</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;. Retrying.&quot;</span>
</span><span class='line'>                    <span class="o">+</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">stringifyException</span><span class="o">(</span><span class="n">e</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="n">Object</span> <span class="nf">invokeMethod</span><span class="o">(</span><span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">method</span><span class="o">.</span><span class="na">isAccessible</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">method</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">implementation</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到对于namenode的方法调用都归结到RetryInvocationHandler的<code>invoke()</code>上了，而这个方法就通过反射再调用rpcNamenode的对应方法，只不过它会retry，也就是说如果调用失败的话，它还会重新尝试调用，这么一来可靠性就增强了，毕竟网络传输很容易出问题的。如果让DFSClient直接调用rpcNamenode的话，一旦失败就会立刻告诉用户，而其实如果多尝试几次还是可能会成功的，这就是为什么要引入namenode的原因了。至此我们就知道client是如何将用户对DistributedFileSystem的方法调用传递到server端的，最后用一张图来总结。</p>

<p><img src="/images/post/hdfs-source-code-analysis/hdfs_client_send_request.png"></p>

<p>参考链接：
<a href="http://blog.csdn.net/historyasamirror/article/details/6159248">1</a>
<a href="http://caibinbupt.iteye.com/blog/280790">2</a>
<a href="http://caibinbupt.iteye.com/blog/281281">3</a>
<a href="http://caibinbupt.iteye.com/blog/281476">4</a>
<a href="http://http://blog.csdn.net/xhh198781/article/details/7268298">5</a>
<a href="http://assets.en.oreilly.com/1/event/12/HDFS%20Under%20the%20Hood%20Presentation%201.pdf">6</a></p>

<h2><a id="hdfs_server_handle_client_request"></a> HDFS服务器对客户端请求的处理</h2>

<p>上面我们提到了客户端如何将rpc方法调用的请求传送给了HDFS服务器也就是namenode，在这一节就要看一下服务器是如何接受请求并处理的。首先看的是org.apache.hadoop.hdfs.server.namenode的代码，这个类代表了HDFS中的namenode。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/* NameNode.java */</span>
</span><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">Configuration</span> <span class="n">conf</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// omitted </span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">serviceRpcServer</span> <span class="o">=</span> <span class="n">RPC</span><span class="o">.</span><span class="na">getServer</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">dnSocketAddr</span><span class="o">.</span><span class="na">getHostName</span><span class="o">(),</span>
</span><span class='line'>            <span class="n">dnSocketAddr</span><span class="o">.</span><span class="na">getPort</span><span class="o">(),</span> <span class="n">serviceHandlerCount</span><span class="o">,</span>
</span><span class='line'>            <span class="kc">false</span><span class="o">,</span> <span class="n">conf</span><span class="o">,</span> <span class="n">namesystem</span><span class="o">.</span><span class="na">getDelegationTokenSecretManager</span><span class="o">());</span> <span class="c1">// handle request from datanode</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">server</span> <span class="o">=</span> <span class="n">RPC</span><span class="o">.</span><span class="na">getServer</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">socAddr</span><span class="o">.</span><span class="na">getHostName</span><span class="o">(),</span> <span class="c1">// namenode将自己的实例传进去了，将来server就会调用namenode的方法来完成请求，比如namenode.mkdirs</span>
</span><span class='line'>        <span class="n">socAddr</span><span class="o">.</span><span class="na">getPort</span><span class="o">(),</span> <span class="n">handlerCount</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">conf</span><span class="o">,</span> <span class="n">namesystem</span>
</span><span class='line'>        <span class="o">.</span><span class="na">getDelegationTokenSecretManager</span><span class="o">());</span> <span class="c1">// handle request from client</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">startHttpServer</span><span class="o">(</span><span class="n">conf</span><span class="o">);</span> <span class="c1">// handle request from http </span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>  <span class="c1">//start RPC server   </span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">serviceRpcServer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">serviceRpcServer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="c1">// omitted</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到在初始化NameNode时一共开启了三个服务器，其中serviceRpcServer是用来处理datanode的请求，比如datanode要定期发送心跳包。server是用来处理client的请求。最后还有一个http服务器。因此我们这里只关心server服务器而忽略其他两个。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/* RPC.java */</span>
</span><span class='line'><span class="cm">/** Construct a server for a protocol implementation instance listening on a</span>
</span><span class='line'><span class="cm"> * port and address, with a secret manager. */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">Server</span> <span class="nf">getServer</span><span class="o">(</span><span class="kd">final</span> <span class="n">Object</span> <span class="n">instance</span><span class="o">,</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">bindAddress</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">port</span><span class="o">,</span>
</span><span class='line'>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">numHandlers</span><span class="o">,</span>
</span><span class='line'>        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">verbose</span><span class="o">,</span> <span class="n">Configuration</span> <span class="n">conf</span><span class="o">,</span>
</span><span class='line'>        <span class="n">SecretManager</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">TokenIdentifier</span><span class="o">&gt;</span> <span class="n">secretManager</span><span class="o">)</span>
</span><span class='line'><span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nf">Server</span><span class="o">(</span><span class="n">instance</span><span class="o">,</span> <span class="n">conf</span><span class="o">,</span> <span class="n">bindAddress</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">numHandlers</span><span class="o">,</span> <span class="n">verbose</span><span class="o">,</span> <span class="n">secretManager</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Server</span> <span class="kd">extends</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hadoop</span><span class="o">.</span><span class="na">ipc</span><span class="o">.</span><span class="na">Server</span> <span class="o">{</span> <span class="c1">// RPC的一个静态内部类</span>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">Server</span><span class="o">(</span><span class="n">Object</span> <span class="n">instance</span><span class="o">,</span> <span class="n">Configuration</span> <span class="n">conf</span><span class="o">,</span> <span class="n">String</span> <span class="n">bindAddress</span><span class="o">,</span>  <span class="kt">int</span> <span class="n">port</span><span class="o">,</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">numHandlers</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">verbose</span><span class="o">,</span>
</span><span class='line'>            <span class="n">SecretManager</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">TokenIdentifier</span><span class="o">&gt;</span> <span class="n">secretManager</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">(</span><span class="n">bindAddress</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">Invocation</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">numHandlers</span><span class="o">,</span> <span class="n">conf</span><span class="o">,</span>
</span><span class='line'>                <span class="n">classNameBase</span><span class="o">(</span><span class="n">instance</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()),</span> <span class="n">secretManager</span><span class="o">);</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">instance</span> <span class="o">=</span> <span class="n">instance</span><span class="o">;</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>最终建立的是org.apache.hadoop.ipc.Server的一个子类，这个类只是实现了父类的抽象方法<code>call()</code>，其他的功能都由父类提供了。因此我们主要专注org.apache.hadoop.ipc.Server类</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/* Server.java */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Server</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Listener</span> <span class="n">listener</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Responder</span> <span class="n">responder</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kt">int</span> <span class="n">numConnections</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Handler</span><span class="o">[]</span> <span class="n">handlers</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Call</span><span class="o">&gt;</span> <span class="n">callQueue</span><span class="o">;</span> <span class="c1">// queued calls</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/** Starts the service.  Must be called before any calls will be handled. */</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">responder</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>      <span class="n">listener</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>      <span class="n">handlers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">[</span><span class="n">handlerCount</span><span class="o">];</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">handlerCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">handlers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span><span class='line'>          <span class="n">handlers</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里就截取了比较重要的代码片段，其中包含这一节要主要介绍的Listener，Responder，Handler，它们就是Server中的3大组件。这三个类都继承了Thread，也就是说它们的每个实例都将是一个线程。下面分别来介绍这三大组件。</p>

<h3>Listener</h3>

<p>首先我们先来看一下Listener的一部分源码</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/* Server.java */</span>
</span><span class='line'><span class="cm">/** Listens on the socket. Creates jobs for the handler threads*/</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">class</span> <span class="nc">Listener</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">ServerSocketChannel</span> <span class="n">acceptChannel</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">//the accept channel</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">//the selector that we use for the server</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Reader</span><span class="o">[]</span> <span class="n">readers</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="c1">// omitted</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">Listener</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">address</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="n">bindAddress</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
</span><span class='line'>        <span class="c1">// Create a new server socket and set to non blocking mode</span>
</span><span class='line'>        <span class="n">acceptChannel</span> <span class="o">=</span> <span class="n">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
</span><span class='line'>        <span class="n">acceptChannel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Bind the server socket to the local host and port</span>
</span><span class='line'>        <span class="n">bind</span><span class="o">(</span><span class="n">acceptChannel</span><span class="o">.</span><span class="na">socket</span><span class="o">(),</span> <span class="n">address</span><span class="o">,</span> <span class="n">backlogLength</span><span class="o">);</span>
</span><span class='line'>        <span class="n">port</span> <span class="o">=</span> <span class="n">acceptChannel</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">getLocalPort</span><span class="o">();</span> <span class="c1">//Could be an ephemeral port</span>
</span><span class='line'>        <span class="c1">// create a selector;</span>
</span><span class='line'>        <span class="n">selector</span><span class="o">=</span> <span class="n">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
</span><span class='line'>        <span class="n">readers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Reader</span><span class="o">[</span><span class="n">readThreads</span><span class="o">];</span>
</span><span class='line'>        <span class="n">readPool</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="n">readThreads</span><span class="o">);</span>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">readThreads</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Selector</span> <span class="n">readSelector</span> <span class="o">=</span> <span class="n">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
</span><span class='line'>            <span class="n">Reader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Reader</span><span class="o">(</span><span class="n">readSelector</span><span class="o">);</span>
</span><span class='line'>            <span class="n">readers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">reader</span><span class="o">;</span>
</span><span class='line'>            <span class="n">readPool</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">reader</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Register accepts on the server socket with the selector.</span>
</span><span class='line'>        <span class="n">acceptChannel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">);</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&quot;IPC Server listener on &quot;</span> <span class="o">+</span> <span class="n">port</span><span class="o">);</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">setDaemon</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;: starting&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">SERVER</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">Server</span><span class="o">.</span><span class="na">this</span><span class="o">);</span>
</span><span class='line'>        <span class="k">while</span> <span class="o">(</span><span class="n">running</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
</span><span class='line'>                <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
</span><span class='line'>                <span class="k">while</span> <span class="o">(</span><span class="n">iter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">key</span> <span class="o">=</span> <span class="n">iter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
</span><span class='line'>                    <span class="n">iter</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
</span><span class='line'>                    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                        <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                            <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isAcceptable</span><span class="o">())</span>
</span><span class='line'>                                <span class="n">doAccept</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="n">key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>              <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">OutOfMemoryError</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// omitted</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="c1">// omitted</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">void</span> <span class="nf">doAccept</span><span class="o">(</span><span class="n">SelectionKey</span> <span class="n">key</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span>  <span class="n">OutOfMemoryError</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Connection</span> <span class="n">c</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="n">ServerSocketChannel</span> <span class="n">server</span> <span class="o">=</span> <span class="o">(</span><span class="n">ServerSocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
</span><span class='line'>        <span class="n">SocketChannel</span> <span class="n">channel</span><span class="o">;</span>
</span><span class='line'>        <span class="k">while</span> <span class="o">((</span><span class="n">channel</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">channel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span><span class='line'>            <span class="n">channel</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">setTcpNoDelay</span><span class="o">(</span><span class="n">tcpNoDelay</span><span class="o">);</span>
</span><span class='line'>            <span class="n">Reader</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">getReader</span><span class="o">();</span> <span class="c1">// 为了让每个reader尽可能平均地分配到channel，目前采用的是round robin方法</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">reader</span><span class="o">.</span><span class="na">startAdd</span><span class="o">();</span>
</span><span class='line'>                <span class="n">SelectionKey</span> <span class="n">readKey</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">registerChannel</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span> <span class="c1">// 将这个channel交由reader来处理</span>
</span><span class='line'>                <span class="n">c</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Connection</span><span class="o">(</span><span class="n">readKey</span><span class="o">,</span> <span class="n">channel</span><span class="o">,</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
</span><span class='line'>                <span class="n">readKey</span><span class="o">.</span><span class="na">attach</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
</span><span class='line'>                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">connectionList</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">connectionList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">numConnections</span><span class="o">,</span> <span class="n">c</span><span class="o">);</span>
</span><span class='line'>                    <span class="n">numConnections</span><span class="o">++;</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">reader</span><span class="o">.</span><span class="na">finishAdd</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Listener主要做的事就是处理客户端的连接请求，它在acceptChannel(相当于listening socket)上监听客户端的连接请求，然后创建一个新的channel(相当于connected socket)作为接下来该客户端和服务器的通讯通道，然后将这个channel分配到某个reader上，让其来处理后续的客户端请求。同时还创建了一个Connection来表示客户端和服务器建立起来的连接，这个类内部有channel的引用，因此其知道这个连接底层的channel(或者说socket)是什么。为了要完全理解上面的代码还需要知道的是Java NIO中的<a href="http://tutorials.jenkov.com/java-nio/selectors.html">Selector</a>。<br/>
我们现在知道真正获取(读取)客户端rpc请求的是Reader类，它实现了Runnable接口即作为一个线程运行，这个类在Listener中只有固定多的实例(可以通过配置文件修改)，因此需要一个reader处理多个客户端的请求，这个在Selector的帮助下将会很容易实现，Reader类中有一个readerSelector的实例来帮助reader处理请求。下面看一下Reader的部分源代码。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/* Server.java */</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">class</span> <span class="nc">Reader</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Selector</span> <span class="n">readSelector</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">while</span> <span class="o">(</span><span class="n">running</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>                <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                    <span class="c1">// 下面都是Selector的典型用法，关键是doRead()函数，这个函数会处理客户端传来的数据</span>
</span><span class='line'>                    <span class="n">readSelector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span> <span class="c1">// 当有channel可读后返回</span>
</span><span class='line'>                    <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">readSelector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
</span><span class='line'>                    <span class="k">while</span> <span class="o">(</span><span class="n">iter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                        <span class="n">key</span> <span class="o">=</span> <span class="n">iter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
</span><span class='line'>                        <span class="n">iter</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
</span><span class='line'>                        <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                            <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                                <span class="n">doRead</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class='line'>                            <span class="o">}</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                        <span class="n">key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                        <span class="c1">// omitted</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">LOG</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;Error in Reader&quot;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="n">SelectionKey</span> <span class="nf">registerChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">channel</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">channel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">readSelector</span><span class="o">,</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">doRead</span><span class="o">(</span><span class="n">SelectionKey</span> <span class="n">key</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>    <span class="c1">// 找出目前处理连接对应的Connection，上面提到过对于每一个已建立的连接都会生成一个Connection来表示</span>
</span><span class='line'>    <span class="c1">// 关于Connection类后面还会详细讨论</span>
</span><span class='line'>    <span class="n">Connection</span> <span class="n">c</span> <span class="o">=</span> <span class="o">(</span><span class="n">Connection</span><span class="o">)</span><span class="n">key</span><span class="o">.</span><span class="na">attachment</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">count</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">readAndProcess</span><span class="o">();</span> <span class="c1">// 交给对应的Connection来处理</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ieo</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// omitted</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="c1">//so that the (count &lt; 0) block is executed</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">closeConnection</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
</span><span class='line'>        <span class="n">c</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">c</span><span class="o">.</span><span class="na">setLastContact</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到Reader做的就是不停地找它所管理的客户端连接中有数据可读的，然后找到这个连接对应的Connection对象，交由相应的connection来处理，于是目光就转向了Connection类。之前说过Connection类表示一个客户端已建立的连接，这个类有一个channel的引用，表示这个连接底层使用的channel(可以理解成socket)。其实Connection类的内容远不止这些，接下来就看看Connection类的代码。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/* Server.java */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Connection</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">SocketChannel</span> <span class="n">channel</span><span class="o">;</span> <span class="c1">// 这个连接底层的channel</span>
</span><span class='line'>    <span class="c1">// 对于客户端的每个rpc函数调用都会生成Call对象，responseQueue保存的是已经处理完的call</span>
</span><span class='line'>    <span class="c1">// call对象里有处理完后的结果，之后要传回给客户端的</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">Call</span><span class="o">&gt;</span> <span class="n">responseQueue</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// number of outstanding rpcs 还没处理完的rpc请求，这里的处理完指的是将结果发回给客户端</span>
</span><span class='line'>    <span class="c1">// 客户端可能会一下子发送多个rpc请求，然后等待所有的结果</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">rpcCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// readAndProcess()做的主要工作是读取一个rpc请求的所有数据</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">readAndProcess</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// omitted</span>
</span><span class='line'>        <span class="n">processOneRpc</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">array</span><span class="o">());</span> <span class="c1">// data就是从channel中获得的一个rpc请求的所有数据</span>
</span><span class='line'>        <span class="c1">// omitted</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">processOneRpc</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">buf</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span><span class="n">InterruptedException</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// omitted</span>
</span><span class='line'>        <span class="n">processData</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
</span><span class='line'>        <span class="c1">// omitted</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">processData</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">buf</span><span class="o">)</span> <span class="kd">throws</span>  <span class="n">IOException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">DataInputStream</span> <span class="n">dis</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">new</span> <span class="nf">DataInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="o">(</span><span class="n">buf</span><span class="o">));</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>                    <span class="c1">// try to read an id</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">Writable</span> <span class="n">param</span> <span class="o">=</span> <span class="n">ReflectionUtils</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">paramClass</span><span class="o">,</span> <span class="n">conf</span><span class="o">);</span><span class="c1">//read param</span>
</span><span class='line'>      <span class="n">param</span><span class="o">.</span><span class="na">readFields</span><span class="o">(</span><span class="n">dis</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">Call</span> <span class="n">call</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Call</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">param</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
</span><span class='line'>      <span class="n">callQueue</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">call</span><span class="o">);</span>              <span class="c1">// queue the call; maybe blocked here</span>
</span><span class='line'>      <span class="n">incRpcCount</span><span class="o">();</span>  <span class="c1">// Increment the rpc count</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>代码跟踪到这就差不多结束了，这些代码大致做了如下的事：首先是<code>readAndProcess()</code>读取一个rpc请求的所有数据，然后一直传到<code>processData()</code>函数处理，<code>processData()</code>函数首先把这些数据转成一个Call对象，这其实可以和上一节介绍的客户端向服务器发送rpc请求对应起来看，可以看作一个序列化和解序列化的过程。这个Call对象就包含了调用的函数名和函数参数，同时之前也提到过Call对象还会保存函数调用过后的结果即返回值。最后将Call对象放入callQueue队列中等待被处理。如果上面还记得Server的代码的话就可以发现callQueue实际上是Server的一个实例变量。我们讨论到现在的Listener，Reader，Connection类和之后要讨论的Handler，Responder都是这个Server的内部类，所以对这些类来说callQueue就相当于一个全局变量了。之前我们提到Listener会有多个Reader来读取很多客户端的rpc请求，所有这些请求被转化成Call对象后都会放入这个全局的callQueue队列中等待被处理。好了，至此Listener组件就全部讲完了，下面是Handler组件。</p>

<h3>Handler</h3>

<p>我们现在知道callQueue中包含了客户端对服务器的rpc调用请求，如何处理这些请求就是Handler的事了。看之前Server的源码我们可以知道Server中存在多个Handler，每个Handler都是一个线程，它们并发地从callQueue中取出一个一个的Call然后进行处理，下面来看看源代码。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/* Server.java  */</span>
</span><span class='line'><span class="cm">/** Handles queued calls . */</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">class</span> <span class="nc">Handler</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">ByteArrayOutputStream</span> <span class="n">buf</span> <span class="o">=</span>
</span><span class='line'>            <span class="k">new</span> <span class="nf">ByteArrayOutputStream</span><span class="o">(</span><span class="n">INITIAL_RESP_BUF_SIZE</span><span class="o">);</span>
</span><span class='line'>        <span class="k">while</span> <span class="o">(</span><span class="n">running</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="kd">final</span> <span class="n">Call</span> <span class="n">call</span> <span class="o">=</span> <span class="n">callQueue</span><span class="o">.</span><span class="na">take</span><span class="o">();</span> <span class="c1">// pop the queue; maybe blocked here 从callQueue中取出一个call进行处理 </span>
</span><span class='line'>
</span><span class='line'>                <span class="n">Writable</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">CurCall</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">call</span><span class="o">);</span>
</span><span class='line'>                <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                    <span class="c1">// Make the call as the user via Subject.doAs, thus associating</span>
</span><span class='line'>                    <span class="c1">// the call with the Subject</span>
</span><span class='line'>                    <span class="k">if</span> <span class="o">(</span><span class="n">call</span><span class="o">.</span><span class="na">connection</span><span class="o">.</span><span class="na">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                        <span class="n">value</span> <span class="o">=</span> <span class="n">call</span><span class="o">(</span><span class="n">call</span><span class="o">.</span><span class="na">connection</span><span class="o">.</span><span class="na">protocol</span><span class="o">,</span> <span class="n">call</span><span class="o">.</span><span class="na">param</span><span class="o">,</span> <span class="n">call</span><span class="o">.</span><span class="na">timestamp</span><span class="o">);</span> <span class="c1">// 处理这个call，也就是找到一个合适的对象调用客户端所要求的方法，并传入参数，最终获得结果</span>
</span><span class='line'>                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                        <span class="n">value</span> <span class="o">=</span>
</span><span class='line'>                            <span class="n">call</span><span class="o">.</span><span class="na">connection</span><span class="o">.</span><span class="na">user</span><span class="o">.</span><span class="na">doAs</span>
</span><span class='line'>                            <span class="o">(</span><span class="k">new</span> <span class="n">PrivilegedExceptionAction</span><span class="o">&lt;</span><span class="n">Writable</span><span class="o">&gt;()</span> <span class="o">{</span>
</span><span class='line'>                                 <span class="kd">public</span> <span class="n">Writable</span> <span class="nf">run</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>                                 <span class="c1">// make the call</span>
</span><span class='line'>                                 <span class="k">return</span> <span class="nf">call</span><span class="o">(</span><span class="n">call</span><span class="o">.</span><span class="na">connection</span><span class="o">.</span><span class="na">protocol</span><span class="o">,</span> <span class="n">call</span><span class="o">.</span><span class="na">param</span><span class="o">,</span> <span class="n">call</span><span class="o">.</span><span class="na">timestamp</span><span class="o">);</span>
</span><span class='line'>                                 <span class="o">}</span>
</span><span class='line'>                             <span class="o">}</span>
</span><span class='line'>                            <span class="o">);</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="c1">// omitted</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>                <span class="n">CurCall</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">call</span><span class="o">.</span><span class="na">connection</span><span class="o">.</span><span class="na">responseQueue</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="c1">// setupResponse() needs to be sync&#39;ed together with </span>
</span><span class='line'>                    <span class="c1">// responder.doResponse() since setupResponse may use</span>
</span><span class='line'>                    <span class="c1">// SASL to encrypt response data and SASL enforces</span>
</span><span class='line'>                    <span class="c1">// its own message ordering.</span>
</span><span class='line'>                    <span class="n">setupResponse</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">call</span><span class="o">,</span>
</span><span class='line'>                            <span class="o">(</span><span class="n">error</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">Status</span><span class="o">.</span><span class="na">SUCCESS</span> <span class="o">:</span> <span class="n">Status</span><span class="o">.</span><span class="na">ERROR</span><span class="o">,</span>
</span><span class='line'>                            <span class="n">value</span><span class="o">,</span> <span class="n">errorClass</span><span class="o">,</span> <span class="n">error</span><span class="o">);</span> <span class="c1">// 设置好返回值，也就是说把返回值等信息保存到call对象里。还记得吗，call对象能保存这个call的执行结果</span>
</span><span class='line'>                    <span class="c1">// Discard the large buf and reset it back to </span>
</span><span class='line'>                    <span class="c1">// smaller size to freeup heap</span>
</span><span class='line'>                    <span class="k">if</span> <span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">maxRespSize</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                      <span class="n">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">(</span><span class="n">INITIAL_RESP_BUF_SIZE</span><span class="o">);</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                    <span class="n">responder</span><span class="o">.</span><span class="na">doRespond</span><span class="o">(</span><span class="n">call</span><span class="o">);</span> <span class="c1">// 处理返回结果</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">running</span><span class="o">)</span> <span class="o">{</span>                          <span class="c1">// unexpected -- log it</span>
</span><span class='line'>                    <span class="c1">// omitted</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// omitted</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到每个Handler线程做的就是从callQueue中取一个call，然后调用Server的call方法处理并获得结果，我们之前提到过这个call方法是抽象方法由具体的子类来实现，这个具体实现的子类我们之前也提到过在RPC.java文件中，具体的代码就不列出来了，只说一下它做了什么。具体call方法做的就是利用反射调用NameNode类的具体方法，在这里就是调用了<code>mkdirs()</code>，大家可以看看是不是NameNode里就有这个方法。获得完函数调用的结果后就把它放入对应的call对象里，然后调用<code>responder.doRespond()</code>方法来处理，于是就引出了Responder这个第三大组件。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/* Server.java */</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">class</span> <span class="nc">Responder</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Selector</span> <span class="n">writeSelector</span><span class="o">;</span> <span class="c1">// 和readSelector异曲同工</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">void</span> <span class="nf">doRespond</span><span class="o">(</span><span class="n">Call</span> <span class="n">call</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">call</span><span class="o">.</span><span class="na">connection</span><span class="o">.</span><span class="na">responseQueue</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">// 将这个call放入其所属的connection(也就是请求这个call的客户端所表示的connection)的responseQueue中等待被处理</span>
</span><span class='line'>            <span class="c1">// responseQueue在之前的Connection的源代码中也有介绍，它和callQueue很类似，只不过一个是全局的，一个是每个Connection都会有一个</span>
</span><span class='line'>            <span class="n">call</span><span class="o">.</span><span class="na">connection</span><span class="o">.</span><span class="na">responseQueue</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">call</span><span class="o">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">call</span><span class="o">.</span><span class="na">connection</span><span class="o">.</span><span class="na">responseQueue</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">processResponse</span><span class="o">(</span><span class="n">call</span><span class="o">.</span><span class="na">connection</span><span class="o">.</span><span class="na">responseQueue</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// processResponse()主要做的就是从responseQueue中取一个call，然后获得这个call的调用结果，还记得当时保存进去了吗</span>
</span><span class='line'>    <span class="c1">// 将调用结果传回到客户端，至此一个rpc请求调用圆满完成</span>
</span><span class='line'>    <span class="c1">// 这个函数可能会在两种情况下被调用：一种是在Handler线程中被调用，就像上面的代码所示，另一种就是在Responder线程中被调用，这个待会会见到</span>
</span><span class='line'>    <span class="c1">// inHandler区别是在哪种情况下被调用</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">processResponse</span><span class="o">(</span><span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">Call</span><span class="o">&gt;</span> <span class="n">responseQueue</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">inHandler</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>        <span class="kt">boolean</span> <span class="n">error</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>        <span class="kt">boolean</span> <span class="n">done</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>       <span class="c1">// there is more data for this channel.</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">numElements</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>        <span class="n">Call</span> <span class="n">call</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">responseQueue</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">//</span>
</span><span class='line'>                <span class="c1">// If there are no items for this channel, then we are done</span>
</span><span class='line'>                <span class="c1">//</span>
</span><span class='line'>                <span class="n">numElements</span> <span class="o">=</span> <span class="n">responseQueue</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">numElements</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">error</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>              <span class="c1">// no more data for this channel.</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>                <span class="c1">//</span>
</span><span class='line'>                <span class="c1">// Extract the first call</span>
</span><span class='line'>                <span class="c1">//</span>
</span><span class='line'>                <span class="n">call</span> <span class="o">=</span> <span class="n">responseQueue</span><span class="o">.</span><span class="na">removeFirst</span><span class="o">();</span>
</span><span class='line'>                <span class="n">SocketChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="na">connection</span><span class="o">.</span><span class="na">channel</span><span class="o">;</span>
</span><span class='line'>                <span class="c1">//</span>
</span><span class='line'>                <span class="c1">// Send as much data as we can in the non-blocking fashion</span>
</span><span class='line'>                <span class="c1">//</span>
</span><span class='line'>                <span class="kt">int</span> <span class="n">numBytes</span> <span class="o">=</span> <span class="n">channelWrite</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="n">call</span><span class="o">.</span><span class="na">response</span><span class="o">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">numBytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(!</span><span class="n">call</span><span class="o">.</span><span class="na">response</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">call</span><span class="o">.</span><span class="na">connection</span><span class="o">.</span><span class="na">decRpcCount</span><span class="o">();</span>
</span><span class='line'>                    <span class="k">if</span> <span class="o">(</span><span class="n">numElements</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>    <span class="c1">// last call fully processes.</span>
</span><span class='line'>                        <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>             <span class="c1">// no more data for this channel.</span>
</span><span class='line'>                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                        <span class="n">done</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>            <span class="c1">// more calls pending to be sent.</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                    <span class="c1">//</span>
</span><span class='line'>                    <span class="c1">// If we were unable to write the entire response out, then </span>
</span><span class='line'>                    <span class="c1">// insert in Selector queue. </span>
</span><span class='line'>                    <span class="c1">//</span>
</span><span class='line'>                    <span class="n">call</span><span class="o">.</span><span class="na">connection</span><span class="o">.</span><span class="na">responseQueue</span><span class="o">.</span><span class="na">addFirst</span><span class="o">(</span><span class="n">call</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                    <span class="k">if</span> <span class="o">(</span><span class="n">inHandler</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                        <span class="c1">// set the serve time when the response has to be sent later</span>
</span><span class='line'>                        <span class="n">call</span><span class="o">.</span><span class="na">timestamp</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>                        <span class="n">incPending</span><span class="o">();</span>
</span><span class='line'>                        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                            <span class="c1">// Wakeup the thread blocked on select, only then can the call </span>
</span><span class='line'>                            <span class="c1">// to channel.register() complete.</span>
</span><span class='line'>                            <span class="n">writeSelector</span><span class="o">.</span><span class="na">wakeup</span><span class="o">();</span>
</span><span class='line'>                            <span class="n">channel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">writeSelector</span><span class="o">,</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_WRITE</span><span class="o">,</span> <span class="n">call</span><span class="o">);</span> <span class="c1">// 让Responder来管理这个channel</span>
</span><span class='line'>                        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClosedChannelException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                            <span class="c1">//Its ok. channel might be closed else where.</span>
</span><span class='line'>                            <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>                        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>                            <span class="n">decPending</span><span class="o">();</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>                <span class="n">error</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>              <span class="c1">// everything went off well</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">closeConnection</span><span class="o">(</span><span class="n">call</span><span class="o">.</span><span class="na">connection</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">done</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="kt">long</span> <span class="n">lastPurgeTime</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>   <span class="c1">// last check for old calls.</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">while</span> <span class="o">(</span><span class="n">running</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">waitPending</span><span class="o">();</span>     <span class="c1">// If a channel is being registered, wait.</span>
</span><span class='line'>                <span class="n">writeSelector</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">PURGE_INTERVAL</span><span class="o">);</span>
</span><span class='line'>                <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">writeSelector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
</span><span class='line'>                <span class="k">while</span> <span class="o">(</span><span class="n">iter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">iter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
</span><span class='line'>                    <span class="n">iter</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
</span><span class='line'>                    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                        <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isValid</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">isWritable</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                            <span class="n">doAsyncWrite</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                        <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;: doAsyncWrite threw exception &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">// omitted</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">OutOfMemoryError</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// omitted</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// omitted</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">doAsyncWrite</span><span class="o">(</span><span class="n">SelectionKey</span> <span class="n">key</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Call</span> <span class="n">call</span> <span class="o">=</span> <span class="o">(</span><span class="n">Call</span><span class="o">)</span><span class="n">key</span><span class="o">.</span><span class="na">attachment</span><span class="o">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">call</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">()</span> <span class="o">!=</span> <span class="n">call</span><span class="o">.</span><span class="na">connection</span><span class="o">.</span><span class="na">channel</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">&quot;doAsyncWrite: bad channel&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">synchronized</span><span class="o">(</span><span class="n">call</span><span class="o">.</span><span class="na">connection</span><span class="o">.</span><span class="na">responseQueue</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">processResponse</span><span class="o">(</span><span class="n">call</span><span class="o">.</span><span class="na">connection</span><span class="o">.</span><span class="na">responseQueue</span><span class="o">,</span> <span class="kc">false</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// 调用processResponse的第二种情况，在Responder线程中调用</span>
</span><span class='line'>                <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">key</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CancelledKeyException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="c1">// omitted</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面就把上面的代码综合起来讲讲。首先在Handler线程中会调用<code>doRespond()</code>，这个方法就把call放入responseQueue中，如果队列中就这一个call就亲自调用<code>processResponse()</code>，也就是说从Handler线程中将返回结果发回给客户端，否则的话就等着到时候由Responder线程来处理。Responder线程通过writeSelector来管理和客户端的连接，不像readSelector关注的是read ready，writeSelector自然关注的是write ready，一旦某个客户端的连接可写后，Responder就找出这个连接对应的Connection对象，然后从Connection的responseQueue中取出call，将结果发送回客户端。可以看到将rpc结果返回给客户端可能发生在Handler线程，也有可能发生在Responder线程。</p>

<p>至此整个流程就讲完了，经过三大组件轮番处理后，总算功德圆满。老规矩，最后附图一张。</p>

<p><img src="/images/post/hdfs-source-code-analysis/hdfs_server_handle_client_request.png"></p>

<p>参考链接：
<a href="http://blog.csdn.net/xhh198781/article/details/7280084">1</a>
<a href="http://blog.csdn.net/xhh198781/article/details/7268298">2</a>
<a href="http://tutorials.jenkov.com/java-nio/selectors.html">3</a></p>

<h2><a id="hdfs_datanode_storage_related_class"></a> DataNode中和数据相关的类</h2>

<p>我们知道DataNode中存放了具体的数据，也就是说HDFS文件系统中的数据(也就是文件)是分散存储在很多个DataNode之中的。但有一点要注意的是DataNode是以Block为单位来存放数据的，一个Block对应于DataNode本地硬盘上的一个文件。而我们认为的HDFS文件系统中的一个文件会被切割成多个Block进行存放，这里就有概念上的文件和实际上的文件的关联。对于client来说HDFS为我们抽象出了一个文件系统，这是个分布式的文件系统，但我们可以像普通文件系统一样来看待它和使用它。我们可以认为HDFS中有个文件A.txt(概念上的文件)，我们可以直接对这个文件进行读写操作，但在底层实现上这个文件会被拆成多个Block(实际上的文件)分散存放在多个DataNode的本地文件系统中。NameNode负责概念上的文件和实际上的文件的转化，比如NameNode知道一个概念上的文件由多少Block组成并且这些Block都在哪些DataNode上，同时NameNode也会维护概念上的目录结构，比如说A.txt在/jjyao/data/路径下。与NameNode相对的就是DataNode，它不知道任何概念上的东西，它不知道什么是A.txt，什么是/jjyao/data，它只知道一个个的Block文件，这些文件都存放在本地的文件系统中。<br/>
Block文件存放在本地的什么地方由配置项dfs.data.dir指定。比如我可以指定这些Block文件都存放在/datanode/data1和/datanode/data2这两个目录下(当然除了存放Block文件DataNode还会存放一些其他文件)。对于每个dfs.data.dir指定的根目录里面有current，detach等目录，其中current目录可以看成是存放Block文件的根目录，这个目录里面可以看成一颗树，树中各级目录下的文件就是Block文件和对应的meta文件。可能有人会问为什么不把所有的Block文件都直接放在current目录下呢，答案是如果Block文件很多的话，本地的文件系统可能不能很好的支持在一个目录下有太多的文件。现在我们大体知道DataNode存了什么数据(更详细的解释参加<a href="http://india.paxcel.net:6060/LargeDataMatters/wp-content/uploads/2010/09/HDFS1.pdf">这里</a>)，那么DataNode中哪些类和这些数据相关就是我们这节要讨论的问题。</p>

<p>在介绍这些类之前写给出一张直观上的图。在这里假设dfs.data.dir规定了/datanode/data1和/datanode/data2两个地方来存放DataNode中的数据，那么就有如下的一张图</p>

<p><img src="/images/post/hdfs-source-code-analysis/hdfs_datanode_storage_abstract.png"></p>

<p>可以看到DataNode通过DataStorage和FSDataset这两个类来管理着存放的数据。从这幅图中可以清晰看出来DataStorage和StorageDirectory属于一个阵营而FSDataset，FSVolumnSet，FSVolume和FSDir属于另一个阵营。它们虽然都用来管理DataNode中存放的数据，但是两块的功能不同。对于DataStorage和StorageDirectory来说主要完成的是HDFS的升级/回滚/提交操作。而对于另外一个阵营里面的类则是真正管理Block文件的，比如添加Block文件。其实只要看DataStorage和FSDataset的接口就可以知道这两个阵营所能做的事。</p>

<h2><a id="hdfs_datanode_start"></a> DataNode的启动</h2>

<p>对于DataNode集群的启动我们可以通过脚本start-all.sh来完成，这个脚本的命令会通过ssh传到各个DataNode所在的机器上，然后Java虚拟机会以DataNode.main()为入口启动DataNode。因此我们的分析也就是从DataNode.main()开始一层层深入，下面看源代码。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/* DataNode.java */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">secureMain</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">secureMain</span><span class="o">(</span><span class="n">String</span> <span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="n">SecureResources</span> <span class="n">resources</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">DataNode</span> <span class="n">datanode</span> <span class="o">=</span> <span class="n">createDataNode</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">resources</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">datanode</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="n">datanode</span><span class="o">.</span><span class="na">join</span><span class="o">();</span> <span class="c1">// 等待DataNode的Daemon进程结束</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(-</span><span class="mi">1</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">DataNode</span> <span class="nf">createDataNode</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[],</span>
</span><span class='line'>        <span class="n">Configuration</span> <span class="n">conf</span><span class="o">,</span> <span class="n">SecureResources</span> <span class="n">resources</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">DataNode</span> <span class="n">dn</span> <span class="o">=</span> <span class="n">instantiateDataNode</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="n">conf</span><span class="o">,</span> <span class="n">resources</span><span class="o">);</span>
</span><span class='line'>    <span class="n">runDatanodeDaemon</span><span class="o">(</span><span class="n">dn</span><span class="o">);</span> <span class="c1">// 把DataNode当作一个Daemon进程启动，运行DataNode.run()方法</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">dn</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">DataNode</span> <span class="nf">instantiateDataNode</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[],</span>
</span><span class='line'>        <span class="n">Configuration</span> <span class="n">conf</span><span class="o">,</span> <span class="n">SecureResources</span> <span class="n">resources</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span><span class="o">[]</span> <span class="n">dataDirs</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="na">getStrings</span><span class="o">(</span><span class="n">DATA_DIR_KEY</span><span class="o">);</span> <span class="c1">// 获取配置项dfs.data.dir的值，也就是DataNode中存放数据的目录</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">makeInstance</span><span class="o">(</span><span class="n">dataDirs</span><span class="o">,</span> <span class="n">conf</span><span class="o">,</span> <span class="n">resources</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">DataNode</span> <span class="nf">makeInstance</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">dataDirs</span><span class="o">,</span> <span class="n">Configuration</span> <span class="n">conf</span><span class="o">,</span>
</span><span class='line'>        <span class="n">SecureResources</span> <span class="n">resources</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">LocalFileSystem</span> <span class="n">localFS</span> <span class="o">=</span> <span class="n">FileSystem</span><span class="o">.</span><span class="na">getLocal</span><span class="o">(</span><span class="n">conf</span><span class="o">);</span>
</span><span class='line'>    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">dirs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;();</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">dir</span> <span class="o">:</span> <span class="n">dataDirs</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">// 检查配置项dfs.data.dir中给出的路径是否valid，比如确实是个目录而不是文件</span>
</span><span class='line'>            <span class="n">DiskChecker</span><span class="o">.</span><span class="na">checkDir</span><span class="o">(</span><span class="n">localFS</span><span class="o">,</span> <span class="k">new</span> <span class="n">Path</span><span class="o">(</span><span class="n">dir</span><span class="o">),</span> <span class="n">dataDirPermission</span><span class="o">);</span>
</span><span class='line'>            <span class="n">dirs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">dir</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">// omitted</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">dirs</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="c1">// 至少要存在一个valid的目录，不然。。。</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">DataNode</span><span class="o">(</span><span class="n">conf</span><span class="o">,</span> <span class="n">dirs</span><span class="o">,</span> <span class="n">resources</span><span class="o">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">DataNode</span><span class="o">(</span><span class="kd">final</span> <span class="n">Configuration</span> <span class="n">conf</span><span class="o">,</span>
</span><span class='line'>        <span class="kd">final</span> <span class="n">AbstractList</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">dataDirs</span><span class="o">,</span> <span class="n">SecureResources</span> <span class="n">resources</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">super</span><span class="o">(</span><span class="n">conf</span><span class="o">);</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">startDataNode</span><span class="o">(</span><span class="n">conf</span><span class="o">,</span> <span class="n">dataDirs</span><span class="o">,</span> <span class="n">resources</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ie</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">shutdown</span><span class="o">();</span>
</span><span class='line'>        <span class="k">throw</span> <span class="n">ie</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 启动的主要工作都在这里</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">startDataNode</span><span class="o">(</span><span class="n">Configuration</span> <span class="n">conf</span><span class="o">,</span>
</span><span class='line'>        <span class="n">AbstractList</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">dataDirs</span><span class="o">,</span> <span class="n">SecureResources</span> <span class="n">resources</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// use configured nameserver &amp; interface to get local hostname</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">conf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;slave.host.name&quot;</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">machineName</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;slave.host.name&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">InetSocketAddress</span> <span class="n">nameNodeAddr</span> <span class="o">=</span> <span class="n">NameNode</span><span class="o">.</span><span class="na">getServiceAddress</span><span class="o">(</span><span class="n">conf</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">InetSocketAddress</span> <span class="n">socAddr</span> <span class="o">=</span> <span class="n">DataNode</span><span class="o">.</span><span class="na">getStreamingAddr</span><span class="o">(</span><span class="n">conf</span><span class="o">);</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">tmpPort</span> <span class="o">=</span> <span class="n">socAddr</span><span class="o">.</span><span class="na">getPort</span><span class="o">();</span>
</span><span class='line'>    <span class="n">storage</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataStorage</span><span class="o">();</span>
</span><span class='line'>    <span class="c1">// construct registration</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">dnRegistration</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DatanodeRegistration</span><span class="o">(</span><span class="n">machineName</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">tmpPort</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// connect to name node</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">namenode</span> <span class="o">=</span> <span class="o">(</span><span class="n">DatanodeProtocol</span><span class="o">)</span> <span class="c1">// 有没有很熟悉，和之前客户端向NameNode发送rpc请求的原理差不多</span>
</span><span class='line'>        <span class="n">RPC</span><span class="o">.</span><span class="na">waitForProxy</span><span class="o">(</span><span class="n">DatanodeProtocol</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
</span><span class='line'>                <span class="n">DatanodeProtocol</span><span class="o">.</span><span class="na">versionID</span><span class="o">,</span>
</span><span class='line'>                <span class="n">nameNodeAddr</span><span class="o">,</span>
</span><span class='line'>                <span class="n">conf</span><span class="o">);</span>
</span><span class='line'>    <span class="c1">// get version and id info from the name-node</span>
</span><span class='line'>    <span class="n">NamespaceInfo</span> <span class="n">nsInfo</span> <span class="o">=</span> <span class="n">handshake</span><span class="o">();</span> <span class="c1">// 获取NameNode的版本信息，用来确保DataNode和NameNode的版本是一样的</span>
</span><span class='line'>    <span class="n">StartupOption</span> <span class="n">startOpt</span> <span class="o">=</span> <span class="n">getStartupOption</span><span class="o">(</span><span class="n">conf</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// read storage info, lock data dirs and transition fs state if necessary</span>
</span><span class='line'>    <span class="n">storage</span><span class="o">.</span><span class="na">recoverTransitionRead</span><span class="o">(</span><span class="n">nsInfo</span><span class="o">,</span> <span class="n">dataDirs</span><span class="o">,</span> <span class="n">startOpt</span><span class="o">);</span>
</span><span class='line'>    <span class="c1">// adjust</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">dnRegistration</span><span class="o">.</span><span class="na">setStorageInfo</span><span class="o">(</span><span class="n">storage</span><span class="o">);</span>
</span><span class='line'>    <span class="c1">// 创建一个FSDataset实例，创建完成后FSDataset内部就会有像上一节那样的图了</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">data</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FSDataset</span><span class="o">(</span><span class="n">storage</span><span class="o">,</span> <span class="n">conf</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// find free port or use privileged port provide</span>
</span><span class='line'>    <span class="n">ServerSocket</span> <span class="n">ss</span><span class="o">;</span>
</span><span class='line'>    <span class="k">if</span><span class="o">(</span><span class="n">secureResources</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">ss</span> <span class="o">=</span> <span class="o">(</span><span class="n">socketWriteTimeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">?</span>
</span><span class='line'>            <span class="n">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">().</span><span class="na">socket</span><span class="o">()</span> <span class="o">:</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">();</span>
</span><span class='line'>        <span class="n">Server</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">ss</span><span class="o">,</span> <span class="n">socAddr</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">ss</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="na">getStreamingSocket</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="c1">// adjust machine name with the actual port</span>
</span><span class='line'>    <span class="n">tmpPort</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="na">getLocalPort</span><span class="o">();</span>
</span><span class='line'>    <span class="n">selfAddr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="n">ss</span><span class="o">.</span><span class="na">getInetAddress</span><span class="o">().</span><span class="na">getHostAddress</span><span class="o">(),</span>
</span><span class='line'>            <span class="n">tmpPort</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">threadGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadGroup</span><span class="o">(</span><span class="s">&quot;dataXceiverServer&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="c1">// 这个服务器是用来处理Client或者其他DataNode对于Block文件的处理请求，比如要求发送某个Block文件的内容</span>
</span><span class='line'>    <span class="c1">// 这个服务器上使用的不是RPC机制而是一种流式机制，因为要传输Block文件的内容嘛</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">dataXceiverServer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Daemon</span><span class="o">(</span><span class="n">threadGroup</span><span class="o">,</span>
</span><span class='line'>            <span class="k">new</span> <span class="nf">DataXceiverServer</span><span class="o">(</span><span class="n">ss</span><span class="o">,</span> <span class="n">conf</span><span class="o">,</span> <span class="k">this</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">DataNode</span><span class="o">.</span><span class="na">nameNodeAddr</span> <span class="o">=</span> <span class="n">nameNodeAddr</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//initialize periodic block scanner</span>
</span><span class='line'>    <span class="c1">// 单独的一个线程，定期对所有的Block文件进行扫描校验</span>
</span><span class='line'>    <span class="n">blockScanner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataBlockScanner</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="o">(</span><span class="n">FSDataset</span><span class="o">)</span><span class="n">data</span><span class="o">,</span> <span class="n">conf</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//create a servlet to serve full-file content</span>
</span><span class='line'>    <span class="c1">// 开启一个web服务器，运行通过浏览器来获得DataNode的状态</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">infoServer</span> <span class="o">=</span> <span class="o">(</span><span class="n">secureResources</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>        <span class="o">?</span> <span class="k">new</span> <span class="n">HttpServer</span><span class="o">(</span><span class="s">&quot;datanode&quot;</span><span class="o">,</span> <span class="n">infoHost</span><span class="o">,</span> <span class="n">tmpInfoPort</span><span class="o">,</span> <span class="n">tmpInfoPort</span> <span class="o">==</span> <span class="mi">0</span><span class="o">,</span>
</span><span class='line'>                <span class="n">conf</span><span class="o">,</span> <span class="n">SecurityUtil</span><span class="o">.</span><span class="na">getAdminAcls</span><span class="o">(</span><span class="n">conf</span><span class="o">,</span> <span class="n">DFSConfigKeys</span><span class="o">.</span><span class="na">DFS_ADMIN</span><span class="o">))</span>
</span><span class='line'>        <span class="o">:</span> <span class="k">new</span> <span class="n">HttpServer</span><span class="o">(</span><span class="s">&quot;datanode&quot;</span><span class="o">,</span> <span class="n">infoHost</span><span class="o">,</span> <span class="n">tmpInfoPort</span><span class="o">,</span> <span class="n">tmpInfoPort</span> <span class="o">==</span> <span class="mi">0</span><span class="o">,</span>
</span><span class='line'>                <span class="n">conf</span><span class="o">,</span> <span class="n">SecurityUtil</span><span class="o">.</span><span class="na">getAdminAcls</span><span class="o">(</span><span class="n">conf</span><span class="o">,</span> <span class="n">DFSConfigKeys</span><span class="o">.</span><span class="na">DFS_ADMIN</span><span class="o">),</span>
</span><span class='line'>                <span class="n">secureResources</span><span class="o">.</span><span class="na">getListener</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">infoServer</span><span class="o">.</span><span class="na">addServlet</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="s">&quot;/blockScannerReport&quot;</span><span class="o">,</span>
</span><span class='line'>            <span class="n">DataBlockScanner</span><span class="o">.</span><span class="na">Servlet</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">infoServer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// BlockTokenSecretManager is created here, but it shouldn&#39;t be</span>
</span><span class='line'>    <span class="c1">// used until it is initialized in register().</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">blockTokenSecretManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BlockTokenSecretManager</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span>
</span><span class='line'>            <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span><span class='line'>    <span class="c1">//init ipc server</span>
</span><span class='line'>    <span class="n">InetSocketAddress</span> <span class="n">ipcAddr</span> <span class="o">=</span> <span class="n">NetUtils</span><span class="o">.</span><span class="na">createSocketAddr</span><span class="o">(</span>
</span><span class='line'>            <span class="n">conf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;dfs.datanode.ipc.address&quot;</span><span class="o">));</span>
</span><span class='line'>    <span class="c1">// 这个RPC服务器和NameNode上的RPC服务器是一样的实现</span>
</span><span class='line'>    <span class="n">ipcServer</span> <span class="o">=</span> <span class="n">RPC</span><span class="o">.</span><span class="na">getServer</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">ipcAddr</span><span class="o">.</span><span class="na">getHostName</span><span class="o">(),</span> <span class="n">ipcAddr</span><span class="o">.</span><span class="na">getPort</span><span class="o">(),</span>
</span><span class='line'>            <span class="n">conf</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;dfs.datanode.handler.count&quot;</span><span class="o">,</span> <span class="mi">3</span><span class="o">),</span> <span class="kc">false</span><span class="o">,</span> <span class="n">conf</span><span class="o">,</span>
</span><span class='line'>            <span class="n">blockTokenSecretManager</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>总结一下DataNode初始化的时候大致干了些什么事。首先初始化了一个NameNode的Remote Proxy，这样以后和NameNode进行通信就方便啦。然后就把上一节介绍的两大阵营的类给初始化好，这样以后DataNode就可以通过FSDataset和DataStorage来操作DataNode中存储的所有数据了。接下来初始化了三个服务器和一个DataBlockScanner，三个服务器分别是流式机制的dataXceiverServer，web服务器infoServer和RPC服务器ipcServer。<br/>
所有这些都初始化好过后，<code>createDataNode()</code>方法就会调用DataNode的<code>run()</code>方法，然后DataNode就正式跑起来了，下面看源代码。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/* DataNode.java */</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">dataXceiverServer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>    <span class="n">ipcServer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">while</span> <span class="o">(</span><span class="n">shouldRun</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">startDistributedUpgradeIfNeeded</span><span class="o">();</span>
</span><span class='line'>            <span class="n">offerService</span><span class="o">();</span> <span class="c1">// 主要是这个函数</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">shouldRun</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ie</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">shutdown</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Main loop for the DataNode.  Runs until shutdown,</span>
</span><span class='line'><span class="cm"> * forever calling remote NameNode functions.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">offerService</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">while</span> <span class="o">(</span><span class="n">shouldRun</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">now</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// 过一段时间执行一次</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">startTime</span> <span class="o">-</span> <span class="n">lastHeartbeat</span> <span class="o">&gt;</span> <span class="n">heartBeatInterval</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">//</span>
</span><span class='line'>                <span class="c1">// All heartbeat messages include following info:</span>
</span><span class='line'>                <span class="c1">// -- Datanode name</span>
</span><span class='line'>                <span class="c1">// -- data transfer port</span>
</span><span class='line'>                <span class="c1">// -- Total capacity</span>
</span><span class='line'>                <span class="c1">// -- Bytes remaining</span>
</span><span class='line'>                <span class="c1">//</span>
</span><span class='line'>                <span class="n">lastHeartbeat</span> <span class="o">=</span> <span class="n">startTime</span><span class="o">;</span>
</span><span class='line'>                <span class="c1">// 发送心跳包表明DataNode还活着，同时获得NameNode传给DataNode的指令</span>
</span><span class='line'>                <span class="c1">// NameNode和DataNode遵循严格的C/S架构，NameNode不会主动去联系DataNode的</span>
</span><span class='line'>                <span class="c1">// 只有在DataNode联系它的时候才借机传输点命令给DataNode</span>
</span><span class='line'>                <span class="n">DatanodeCommand</span><span class="o">[]</span> <span class="n">cmds</span> <span class="o">=</span> <span class="n">namenode</span><span class="o">.</span><span class="na">sendHeartbeat</span><span class="o">(</span><span class="n">dnRegistration</span><span class="o">,</span>
</span><span class='line'>                        <span class="n">data</span><span class="o">.</span><span class="na">getCapacity</span><span class="o">(),</span>
</span><span class='line'>                        <span class="n">data</span><span class="o">.</span><span class="na">getDfsUsed</span><span class="o">(),</span>
</span><span class='line'>                        <span class="n">data</span><span class="o">.</span><span class="na">getRemaining</span><span class="o">(),</span>
</span><span class='line'>                        <span class="n">xmitsInProgress</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span>
</span><span class='line'>                        <span class="n">getXceiverCount</span><span class="o">());</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(!</span><span class="n">processCommand</span><span class="o">(</span><span class="n">cmds</span><span class="o">))</span>
</span><span class='line'>                    <span class="k">continue</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// check if there are newly received blocks</span>
</span><span class='line'>            <span class="n">Block</span> <span class="o">[]</span> <span class="n">blockArray</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
</span><span class='line'>            <span class="n">String</span> <span class="o">[]</span> <span class="n">delHintArray</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
</span><span class='line'>            <span class="kd">synchronized</span><span class="o">(</span><span class="n">receivedBlockList</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="kd">synchronized</span><span class="o">(</span><span class="n">delHints</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="kt">int</span> <span class="n">numBlocks</span> <span class="o">=</span> <span class="n">receivedBlockList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span><span class='line'>                    <span class="k">if</span> <span class="o">(</span><span class="n">numBlocks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                        <span class="c1">//</span>
</span><span class='line'>                        <span class="c1">// Send newly-received blockids to namenode</span>
</span><span class='line'>                        <span class="c1">//</span>
</span><span class='line'>                        <span class="n">blockArray</span> <span class="o">=</span> <span class="n">receivedBlockList</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="n">Block</span><span class="o">[</span><span class="n">numBlocks</span><span class="o">]);</span>
</span><span class='line'>                        <span class="n">delHintArray</span> <span class="o">=</span> <span class="n">delHints</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">numBlocks</span><span class="o">]);</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">blockArray</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// 告诉NameNode最新接收到的Block文件</span>
</span><span class='line'>                <span class="n">namenode</span><span class="o">.</span><span class="na">blockReceived</span><span class="o">(</span><span class="n">dnRegistration</span><span class="o">,</span> <span class="n">blockArray</span><span class="o">,</span> <span class="n">delHintArray</span><span class="o">);</span>
</span><span class='line'>                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">receivedBlockList</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">delHints</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">blockArray</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>                            <span class="n">receivedBlockList</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">blockArray</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
</span><span class='line'>                            <span class="n">delHints</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">delHintArray</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Send latest blockinfo report if timer has expired.</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">startTime</span> <span class="o">-</span> <span class="n">lastBlockReport</span> <span class="o">&gt;</span> <span class="n">blockReportInterval</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">isAsyncBlockReportReady</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                    <span class="c1">// Create block report</span>
</span><span class='line'>                    <span class="kt">long</span> <span class="n">brCreateStartTime</span> <span class="o">=</span> <span class="n">now</span><span class="o">();</span>
</span><span class='line'>                    <span class="n">Block</span><span class="o">[]</span> <span class="n">bReport</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">retrieveAsyncBlockReport</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>                    <span class="c1">// Send block report</span>
</span><span class='line'>                    <span class="kt">long</span> <span class="n">brSendStartTime</span> <span class="o">=</span> <span class="n">now</span><span class="o">();</span>
</span><span class='line'>                    <span class="c1">// 报告Block文件的信息</span>
</span><span class='line'>                    <span class="n">DatanodeCommand</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">namenode</span><span class="o">.</span><span class="na">blockReport</span><span class="o">(</span><span class="n">dnRegistration</span><span class="o">,</span>
</span><span class='line'>                            <span class="n">BlockListAsLongs</span><span class="o">.</span><span class="na">convertToArrayLongs</span><span class="o">(</span><span class="n">bReport</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>                    <span class="c1">// omitted</span>
</span><span class='line'>                    <span class="n">processCommand</span><span class="o">(</span><span class="n">cmd</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">data</span><span class="o">.</span><span class="na">requestAsyncBlockReport</span><span class="o">();</span>
</span><span class='line'>                    <span class="k">if</span> <span class="o">(</span><span class="n">lastBlockReport</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// this isn&#39;t the first report</span>
</span><span class='line'>                        <span class="c1">// omitted</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// start block scanner</span>
</span><span class='line'>            <span class="c1">// 只会执行一次</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">blockScanner</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">blockScannerThread</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                    <span class="n">upgradeManager</span><span class="o">.</span><span class="na">isUpgradeCompleted</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">blockScannerThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Daemon</span><span class="o">(</span><span class="n">blockScanner</span><span class="o">);</span>
</span><span class='line'>                <span class="n">blockScannerThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">//</span>
</span><span class='line'>            <span class="c1">// There is no work to do;  sleep until hearbeat timer elapses, </span>
</span><span class='line'>            <span class="c1">// or work arrives, and then iterate again.</span>
</span><span class='line'>            <span class="c1">//</span>
</span><span class='line'>            <span class="kt">long</span> <span class="n">waitTime</span> <span class="o">=</span> <span class="n">heartBeatInterval</span> <span class="o">-</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">lastHeartbeat</span><span class="o">);</span>
</span><span class='line'>            <span class="kd">synchronized</span><span class="o">(</span><span class="n">receivedBlockList</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">waitTime</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">receivedBlockList</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                        <span class="n">receivedBlockList</span><span class="o">.</span><span class="na">wait</span><span class="o">(</span><span class="n">waitTime</span><span class="o">);</span>
</span><span class='line'>                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ie</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                    <span class="n">delayBeforeBlockReceived</span><span class="o">();</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span> <span class="c1">// synchronized</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">RemoteException</span> <span class="n">re</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">// omitted</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span> <span class="c1">// while (shouldRun)</span>
</span><span class='line'><span class="o">}</span> <span class="c1">// offerService</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到DataNode把那几个服务器和DataBlockScanner作为独立的线程启动后，自己也进入了一个while循环执行以下的操作：定期发送心跳包和Block信息报告，还发送最新接收到的Block文件信息。至此对于DataNode启动的分析就结束了，在这一过程中遇到的所有细节都没有深究，比如DataBlockScanner的原理是什么，这些都留到以后再介绍。</p>

<p>参考链接：
<a href="http://caibinbupt.iteye.com/blog/287870">1</a></p>

<h2><a id="reference"></a> 参考资料</h2>

<p>在研究源码的过程中也找到了一些比较好的参考资料，仅供参考</p>

<ol>
<li><a href="http://blog.csdn.net/xhh198781">xhh198781的博客</a></li>
<li><a href="http://caibinbupt.iteye.com">caibinbupt的博客</a></li>
<li><a href="http://india.paxcel.net:6060/LargeDataMatters/wp-content/uploads/2010/09/HDFS1.pdf">一份pdf文件</a></li>
</ol>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">jjyao</span></span>

      








  


<time datetime="2012-06-18T19:28:00+08:00" pubdate data-updated="true">Jun 18<span>th</span>, 2012</time>
      


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/06/02/insert-one-million-rows-into-database/" title="Previous Post: Insert One Million Rows Into Database">&laquo; Insert One Million Rows Into Database</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/07/21/wordpress-xml-rpc-api/" title="Next Post: WordPress XML-RPC API">WordPress XML-RPC API &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/03/17/a-close-look-into-php-zval/">A Close Look Into PHP zval</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/25/who-are-you/">Who Are You</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/09/refactor-with-vim/">Refactor with Vim</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/28/openssl-read-ahead-and-epoll/">OpenSSL Read Ahead &amp; Epoll</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/07/php-single-quoted/">PHP single quoted</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/JiajunYao">@JiajunYao</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'JiajunYao',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>

<h1>Weibo</h1>
<ul>
<li>
<iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=300&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=0&uid=2369955640&verifier=a2e3df32&dpc=1">
</iframe>
</li>
</ul>

</section>


<section>

<h1>Douban</h1>
<ul>
<li>
<div><script type="text/javascript" src="http://www.douban.com/service/badge/51087586/?show=dolist&amp;n=4&amp;columns=2&amp;hidelogo=yes&amp;cat=book" ></script></div>
</li>
</ul>

</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - jjyao -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'jjyao';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://JiajunYao.github.com/blog/2012/06/18/hdfs-source-code-analysis/';
        var disqus_url = 'http://JiajunYao.github.com/blog/2012/06/18/hdfs-source-code-analysis/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
